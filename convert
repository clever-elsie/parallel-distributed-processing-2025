#!/bin/bash

# 無視するディレクトリ名（相対パス・部分一致しない）
ignore=("build" "tmp" "ignore_this" "venv")

# 対象拡張子
exts=("png" "jpg" "jpeg" "bmp" "gif" "tif" "tiff")

# "ignore" ディレクトリを find の prune 用正規表現に変換
# → 例: \( -name build -o -name tmp -o -name ignore_this \) -prune
prune_expr=""
for d in "${ignore[@]}"; do
    if [[ -z "$prune_expr" ]]; then
        prune_expr="-name $d"
    else
        prune_expr="$prune_expr -o -name $d"
    fi
done

for ext in "${exts[@]}"; do
    # find を組み立てる（無視ディレクトリは prune）
    find_cmd="find . \( $prune_expr \) -prune -o -type f -iname '*.${ext}' -print"

    eval $find_cmd | while read -r file; do
        eps="${file%.*}.eps"

        # EPS が存在し、元画像より新しければスキップ
        if [[ -f "$eps" && "$eps" -nt "$file" ]]; then
            echo "Skipping (up-to-date): $file"
            continue
        fi

        echo "Converting: $file → $eps"
        convert "$file" "$eps"
    done
done

